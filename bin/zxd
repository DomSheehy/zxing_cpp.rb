#!/usr/bin/env ruby
require 'rubygems'

# DONT COMMIT
$:.push File.expand_path(File.join(File.dirname(__FILE__),"../lib"))

require 'zxing'
include ZXing

require 'optparse'

options = {
  :rotation => 0
}

macruby = defined?(RUBY_ENGINE) && RUBY_ENGINE == "macruby"

OptionParser.new do |o|
  o.on('-r', '--rotate rotation') do |r|
    options[:rotation] = r
  end
  o.on('-l', '--luminance luminance_file') do |l|
    options[:luminance] = l
  end
  o.on('-b', '--binary binary_file') do |b|
    options[:binary] = b
  end
  o.on('-a', '--ascii ascii_file') do |b|
    options[:ascii] = a
  end
  o.on('-t', '--tryharder') do |th|
    options[:th] = th
  end
  o.on('-q', '--qr') do
    options[:qr] = true
  end
  if macruby
    o.on('-c', '--capture') do
      options[:capture] = true
    end
    o.on('-p', '--preview') do
      options[:preview] = true
    end
    o.on('--nopreview', '--no-preview') do
      options[:preview] = false
    end
    o.on('-B', '--show-binary', '--showbinary') do
      options[:show_binary] = true
    end
    o.on('-L', '--show-luminance', '--showluminance') do
      options[:show_luminance] = true
    end
  end
end.parse!

options.has_key? :preview or options[:preview] = options[:capture]

reader = nil
if !options[:qr]
  reader = MultiFormatReader.new
end

ARGV.each do |filename|
  image = Image.read filename
  rotated = image.rotate options[:rotation].to_f
  source = LuminanceSource.new rotated
  if options[:luminance]
    source.image.write options[:luminance]+".png"
  end
  binarizer = Common::HybridBinarizer.new source
  if options[:binary]
    binarizer.image.write options[:binary]+".png"
  end
  bitmap = BinaryBitmap.new binarizer

  result = nil
  if options[:qr]
    detector = QRCode::Detector.new bitmap.black_matrix
    result = detector.detect
    if options[:ascii]
      raise "hell"
    end
    result = QRCode::Decoder.new.decode result
  else
    result = reader.decode bitmap, options[:th] ? { :try_harder => true } : nil
  end

  puts result.text
end

if macruby && (options[:capture] || options[:preview])
  require 'zxing/objc/zxd'
  app = NSApplication.sharedApplication
  app.delegate = AppDelegate.new options
  app.run
end
